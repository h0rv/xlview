{
  "version": 3,
  "sources": ["viewer.ts"],
  "sourcesContent": ["import init, { XlView } from \"../../pkg/xlview.js\";\nimport type { ManifestEntry } from \"./types.js\";\n\n// Initialize WASM on page load\nawait init();\n\nconst uploadArea = document.getElementById(\"upload-area\") as HTMLLabelElement;\nconst fileInput = document.getElementById(\"file-input\") as HTMLInputElement;\nconst viewerContainer = document.getElementById(\n  \"viewer-container\",\n) as HTMLDivElement;\nconst canvas = document.getElementById(\"viewer-canvas\") as HTMLCanvasElement;\nconst overlayCanvas = document.getElementById(\n  \"viewer-overlay\",\n) as HTMLCanvasElement;\n\nlet viewer: XlView | null = null;\nlet currentFile: File | null = null;\nlet renderPending = false;\n\n// Resize canvases to match container.\n// The main canvas size is controlled by Rust (oversized for buffer pre-rendering).\n// JS only sizes the overlay canvas and reports viewport dimensions.\nfunction resizeCanvas(): number {\n  // After setup_native_scroll, the canvas lives inside a clipping spacer.\n  // Use the scroll container (marked with data-xlview-scroll) for viewport sizing.\n  const target =\n    (document.querySelector(\"[data-xlview-scroll]\") as HTMLElement) ??\n    canvas.parentElement ??\n    viewerContainer;\n  const rect = target.getBoundingClientRect();\n  const width = target.clientWidth || rect.width;\n  const height = target.clientHeight || rect.height;\n  const dpr = window.devicePixelRatio || 1;\n\n  const physW = Math.max(1, Math.round(width * dpr));\n  const physH = Math.max(1, Math.round(height * dpr));\n\n  // Overlay canvas: always viewport-sized (follows scroll via CSS transform)\n  overlayCanvas.width = physW;\n  overlayCanvas.height = physH;\n  overlayCanvas.style.width = width + \"px\";\n  overlayCanvas.style.height = height + \"px\";\n\n  // Before viewer exists, set main canvas to viewport size as a fallback.\n  // Once viewer.resize() is called, Rust overrides to buffer dimensions.\n  if (!viewer) {\n    canvas.width = physW;\n    canvas.height = physH;\n    canvas.style.width = width + \"px\";\n    canvas.style.height = height + \"px\";\n  }\n\n  const effectiveDpr = width > 0 ? physW / width : dpr;\n  if (viewer) {\n    // Rust resize() will set the main canvas to oversized buffer dimensions.\n    viewer.resize(physW, physH, effectiveDpr);\n  }\n  return effectiveDpr;\n}\n\n(window as unknown as Record<string, unknown>).force_resize = resizeCanvas;\n\n// Request render on next animation frame\nfunction requestRender(): void {\n  if (renderPending) return;\n  renderPending = true;\n  requestAnimationFrame(() => {\n    renderPending = false;\n    if (viewer) {\n      try {\n        viewer.render();\n      } catch (e) {\n        console.error(\"Render error:\", e);\n      }\n    }\n  });\n}\n\n// Initialize viewer with Canvas 2D\nasync function initViewer(): Promise<boolean> {\n  try {\n    const dpr = resizeCanvas() || window.devicePixelRatio || 1;\n    viewer = XlView.newWithOverlay\n      ? XlView.newWithOverlay(canvas, overlayCanvas, dpr)\n      : new XlView(canvas, dpr);\n    viewer.set_render_callback(requestRender);\n    // Defer resize/render to next frame to ensure DOM layout is complete\n    // after setup_native_scroll moves canvases to new container\n    requestAnimationFrame(() => {\n      resizeCanvas();\n      requestRender();\n    });\n    return true;\n  } catch (e) {\n    showError(`Failed to initialize viewer: ${e}`);\n    return false;\n  }\n}\n\n// Drag and drop on upload button\nuploadArea.addEventListener(\"dragover\", (e: DragEvent) => {\n  e.preventDefault();\n  uploadArea.classList.add(\"dragover\");\n});\n\nuploadArea.addEventListener(\"dragleave\", () => {\n  uploadArea.classList.remove(\"dragover\");\n});\n\nuploadArea.addEventListener(\"drop\", (e: DragEvent) => {\n  e.preventDefault();\n  uploadArea.classList.remove(\"dragover\");\n\n  const file = e.dataTransfer?.files[0];\n  if (file) handleFile(file);\n});\n\n// File input change\nfileInput.addEventListener(\"change\", () => {\n  const file = fileInput.files?.[0];\n  if (file) handleFile(file);\n});\n\n// Window resize\nwindow.addEventListener(\"resize\", resizeCanvas);\n\n// Load test file buttons dynamically from manifest\nasync function loadTestFileButtons(): Promise<void> {\n  const container = document.getElementById(\"test-files\");\n  const uploadBtn = document.getElementById(\"upload-area\");\n\n  try {\n    const response = await fetch(\"test/manifest.json\");\n    if (!response.ok) {\n      // Keep just the upload button\n      return;\n    }\n    const manifest: ManifestEntry[] = await response.json();\n\n    // Insert buttons before the upload button\n    for (const file of manifest) {\n      const btn = document.createElement(\"button\");\n      btn.style.cssText =\n        \"padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;\";\n      btn.textContent = `${file.name} (${file.size})`;\n      btn.addEventListener(\"click\", () => loadTestFile(`test/${file.name}`));\n      container?.insertBefore(btn, uploadBtn);\n    }\n  } catch {\n    // Keep just the upload button on error\n  }\n}\nloadTestFileButtons();\n\nasync function loadTestFile(path: string): Promise<void> {\n  try {\n    const response = await fetch(path);\n    if (!response.ok)\n      throw new Error(`Failed to fetch ${path}: ${response.status}`);\n    const blob = await response.blob();\n    const file = new File([blob], path.split(\"/\").pop() ?? \"file.xlsx\", {\n      type: blob.type,\n    });\n    currentFile = file;\n    await handleFile(file);\n  } catch (err) {\n    showError(`Failed to load file: ${(err as Error).message}`);\n  }\n}\n\nasync function handleFile(file: File): Promise<void> {\n  if (!file.name.match(/\\.xlsx?$/i)) {\n    showError(\"Please select an Excel file (.xlsx)\");\n    return;\n  }\n\n  currentFile = file;\n\n  // Initialize viewer if not already done\n  if (!viewer) {\n    const success = await initViewer();\n    if (!success) return;\n  }\n\n  try {\n    const arrayBuffer = await file.arrayBuffer();\n    viewer!.load(new Uint8Array(arrayBuffer));\n    // Force layout recalculation after load - DOM changes from load()\n    // may not be reflected in dimensions immediately\n    resizeCanvas();\n  } catch (err) {\n    showError(`Failed to load file: ${(err as Error).message}`);\n  }\n}\n\nfunction showError(message: string): void {\n  viewerContainer.innerHTML = `<div class=\"error\">${message}</div>`;\n  viewer = null;\n}\n\n// Suppress unused variable warnings\nvoid currentFile;\n\n// Initialize on page load\ninitViewer();\n"],
  "mappings": "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",
  "names": []
}
